<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أنا وطني | رحلة التأسيس</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="games.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .photo-booth {
            padding-top: 100px;
            background: linear-gradient(135deg, #f8f4ef 0%, #e8dfd6 100%);
            min-height: 100vh;
        }
        
        .booth-header {
            text-align: center;
            padding: 2rem 0;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-green) 100%);
            color: white;
            margin-bottom: 2rem;
        }
        
        .booth-header h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .booth-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .booth-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 1024px) {
            .booth-layout {
                grid-template-columns: 1fr;
            }
        }
        
        .booth-controls {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .control-section {
            margin-bottom: 2rem;
        }
        
        .control-section h3 {
            color: var(--primary-dark);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light-beige);
        }
        
        .backgrounds-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        
        .background-btn {
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .background-btn.active {
            border-color: var(--secondary-green);
            transform: scale(1.05);
        }
        
        .background-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .background-btn img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }
        
        .background-name {
            position: absolute;
            bottom: 0;
            right: 0;
            left: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0.25rem;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .frames-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        
        .frame-btn {
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            padding: 0.5rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .frame-btn.active {
            border-color: var(--secondary-green);
            background: var(--light-beige);
            transform: scale(1.05);
        }
        
        .frame-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .frame-btn i {
            font-size: 1.5rem;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .frame-name {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        .stickers-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        
        .sticker-btn {
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            padding: 0.5rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .sticker-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .sticker-btn img {
            width: 100%;
            height: 50px;
            object-fit: contain;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        
        .filter-btn {
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            padding: 0.5rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .filter-btn.active {
            border-color: var(--secondary-green);
            background: var(--light-beige);
        }
        
        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .filter-preview {
            width: 100%;
            height: 40px;
            border-radius: 5px;
            margin-bottom: 0.25rem;
        }
        
        .filter-name {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        .camera-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .control-btn {
            padding: 12px;
            border-radius: 50px;
            border: 2px solid var(--light-gray);
            background: white;
            color: var(--primary-dark);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .control-btn.primary {
            background: var(--secondary-green);
            color: white;
            border-color: var(--secondary-green);
        }
        
        .control-btn.danger {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        
        .booth-area {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .camera-container {
            position: relative;
            margin-bottom: 2rem;
        }
        
        #cameraView {
            width: 100%;
            height: 500px;
            background: #333;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        #cameraVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* عكس الصورة للمرآة */
        }
        
        #cameraCanvas {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            display: none;
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .overlay-element {
            position: absolute;
            pointer-events: auto;
            cursor: move;
            user-select: none;
        }
        
        .capture-btn {
            position: absolute;
            bottom: 20px;
            right: 50%;
            transform: translateX(50%);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            border: 5px solid var(--secondary-green);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--secondary-green);
            transition: all 0.3s;
        }
        
        .capture-btn:hover {
            transform: translateX(50%) scale(1.1);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .photo-preview {
            display: none;
            margin-top: 2rem;
            text-align: center;
        }
        
        .preview-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
        }
        
        #photoResult {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .preview-controls {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        .gallery {
            margin-top: 3rem;
        }
        
        .gallery h3 {
            color: var(--primary-dark);
            margin-bottom: 1rem;
        }
        
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .photo-item {
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .photo-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .photo-info {
            position: absolute;
            bottom: 0;
            right: 0;
            left: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0.5rem;
            font-size: 0.8rem;
        }
        
        .modal-content.photo-modal {
            max-width: 800px;
        }
        
        .photo-share {
            text-align: center;
            padding: 2rem;
        }
        
        .share-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .share-option {
            padding: 1rem;
            background: var(--light-beige);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .share-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .share-option i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .twitter-option {
            color: #1DA1F2;
        }
        
        .instagram-option {
            color: #E4405F;
        }
        
        .whatsapp-option {
            color: #25D366;
        }
        
        .download-option {
            color: var(--secondary-green);
        }
        
        @media (max-width: 768px) {
            .booth-header h1 {
                font-size: 2rem;
            }
            
            .backgrounds-grid {
                grid-template-columns: 1fr;
            }
            
            .frames-grid,
            .stickers-grid,
            .filters-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .capture-btn {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <img src="../assets/images/logo.png" alt="شعار يوم التأسيس" class="logo-img">
                <span class="logo-text">رحلة التأسيس</span>
            </div>
            
            <div class="nav-menu">
                <a href="../index.html" class="nav-link"><i class="fas fa-home"></i> الرئيسية</a>
                <a href="../exhibits/" class="nav-link"><i class="fas fa-landmark"></i> المعارض</a>
                <a href="../competition/" class="nav-link"><i class="fas fa-trophy"></i> المسابقة</a>
                <a href="puzzle.html" class="nav-link"><i class="fas fa-puzzle-piece"></i> البازل الزمني</a>
                <a href="drawing.html" class="nav-link"><i class="fas fa-palette"></i> أرسم تاريخك</a>
                <a href="photo-booth.html" class="nav-link active"><i class="fas fa-camera"></i> أنا وطني</a>
            </div>
        </div>
    </nav>

    <main class="photo-booth">
        <div class="booth-header">
            <div class="container">
                <h1>أنا وطني</h1>
                <p>التقطي صورة مع خلفيات تراثية وشاركيها مع زميلاتك</p>
            </div>
        </div>

        <div class="container booth-container">
            <div class="booth-layout">
                <!-- أدوات التحكم -->
                <aside class="booth-controls">
                    <div class="control-section">
                        <h3>خلفيات وطنية</h3>
                        <div class="backgrounds-grid" id="backgroundsGrid">
                            <!-- سيتم تعبئته ديناميكياً -->
                        </div>
                    </div>

                    <div class="control-section">
                        <h3>إطارات الصور</h3>
                        <div class="frames-grid" id="framesGrid">
                            <!-- سيتم تعبئته ديناميكياً -->
                        </div>
                    </div>

                    <div class="control-section">
                        <h3>ملصقات وطنية</h3>
                        <div class="stickers-grid" id="stickersGrid">
                            <!-- سيتم تعبئته ديناميكياً -->
                        </div>
                    </div>

                    <div class="control-section">
                        <h3>فلاتر الصور</h3>
                        <div class="filters-grid" id="filtersGrid">
                            <!-- سيتم تعبئته ديناميكياً -->
                        </div>
                    </div>

                    <div class="camera-controls">
                        <button class="control-btn primary" onclick="startCamera()">
                            <i class="fas fa-camera"></i> تشغيل الكاميرا
                        </button>
                        <button class="control-btn" onclick="switchCamera()">
                            <i class="fas fa-sync-alt"></i> تبديل الكاميرا
                        </button>
                        <button class="control-btn danger" onclick="stopCamera()">
                            <i class="fas fa-stop"></i> إيقاف الكاميرا
                        </button>
                    </div>
                </aside>

                <!-- منطقة الكاميرا -->
                <div class="booth-area">
                    <div class="camera-container">
                        <div id="cameraView">
                            <video id="cameraVideo" autoplay playsinline></video>
                            <canvas id="cameraCanvas"></canvas>
                            <div class="camera-overlay" id="cameraOverlay">
                                <!-- العناصر المركبة تظهر هنا -->
                            </div>
                        </div>
                        
                        <button class="capture-btn" onclick="capturePhoto()" id="captureBtn" style="display: none;">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>

                    <!-- معاينة الصورة -->
                    <div class="photo-preview" id="photoPreview">
                        <h3>صورتك الجديدة</h3>
                        <div class="preview-container">
                            <img id="photoResult" src="" alt="الصورة الملتقطة">
                        </div>
                        
                        <div class="preview-controls">
                            <button class="control-btn" onclick="retakePhoto()">
                                <i class="fas fa-redo"></i> إعادة
                            </button>
                            <button class="control-btn primary" onclick="savePhoto()">
                                <i class="fas fa-save"></i> حفظ
                            </button>
                            <button class="control-btn" onclick="sharePhoto()">
                                <i class="fas fa-share"></i> مشاركة
                            </button>
                        </div>
                    </div>

                    <!-- معرض الصور -->
                    <div class="gallery">
                        <h3>معرض صورك</h3>
                        <div class="photos-grid" id="photosGrid">
                            <!-- سيتم تعبئته ديناميكياً -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- نافذة المشاركة -->
    <div id="shareModal" class="modal">
        <div class="modal-content photo-modal">
            <span class="close" onclick="closeShareModal()">&times;</span>
            
            <div class="photo-share">
                <i class="fas fa-share-alt" style="font-size: 4rem; color: var(--secondary-green); margin-bottom: 1rem;"></i>
                <h2>شارك صورتك الوطنية</h2>
                <p>شارك صورتك مع زميلاتك على وسائل التواصل الاجتماعي</p>
                
                <img id="shareImage" src="" alt="صورة المشاركة" style="max-width: 100%; max-height: 300px; border-radius: 10px; margin: 1rem 0;">
                
                <div class="share-options">
                    <div class="share-option twitter-option" onclick="shareOnTwitter()">
                        <i class="fab fa-twitter"></i>
                        <span>تويتر</span>
                    </div>
                    
                    <div class="share-option instagram-option" onclick="shareOnInstagram()">
                        <i class="fab fa-instagram"></i>
                        <span>إنستغرام</span>
                    </div>
                    
                    <div class="share-option whatsapp-option" onclick="shareOnWhatsApp()">
                        <i class="fab fa-whatsapp"></i>
                        <span>واتساب</span>
                    </div>
                    
                    <div class="share-option download-option" onclick="downloadPhoto()">
                        <i class="fas fa-download"></i>
                        <span>تحميل</span>
                    </div>
                </div>
                
                <div class="share-text">
                    <h3>أضف تعليقاً:</h3>
                    <textarea id="shareCaption" rows="3" placeholder="اكتب تعليقاً لصورتك..." style="width: 100%; padding: 1rem; border-radius: 10px; border: 2px solid var(--light-gray); margin-bottom: 1rem;"></textarea>
                </div>
                
                <button class="control-btn primary" onclick="postToGallery()">
                    <i class="fas fa-images"></i> نشر في المعرض
                </button>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-container">
            <!-- نفس الفوتر السابق -->
        </div>
    </footer>

    <script src="../script.js"></script>
    <script>
        // كود خاص بركن أنا وطني
        class PhotoBooth {
            constructor() {
                this.video = document.getElementById('cameraVideo');
                this.canvas = document.getElementById('cameraCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.overlay = document.getElementById('cameraOverlay');
                this.photoResult = document.getElementById('photoResult');
                this.shareImage = document.getElementById('shareImage');
                
                this.stream = null;
                this.currentCamera = 'user'; // 'user' أو 'environment'
                this.currentBackground = null;
                this.currentFrame = null;
                this.activeStickers = [];
                this.currentFilter = null;
                this.currentPhoto = null;
                
                this.backgrounds = [
                    {
                        id: 1,
                        name: 'قصر المصمك',
                        image: '../assets/images/masmak-bg.jpg',
                        type: 'historical'
                    },
                    {
                        id: 2,
                        name: 'الدرعية',
                        image: '../assets/images/diriyah-bg.jpg',
                        type: 'historical'
                    },
                    {
                        id: 3,
                        name: 'علم المملكة',
                        image: '../assets/images/flag-bg.jpg',
                        type: 'patriotic'
                    },
                    {
                        id: 4,
                        name: 'الصحراء',
                        image: '../assets/images/desert-bg.jpg',
                        type: 'natural'
                    },
                    {
                        id: 5,
                        name: 'النخيل',
                        image: '../assets/images/palm-bg.jpg',
                        type: 'natural'
                    },
                    {
                        id: 6,
                        name: 'الرياض الخضراء',
                        image: '../assets/images/riyadh-bg.jpg',
                        type: 'modern'
                    }
                ];
                
                this.frames = [
                    {
                        id: 1,
                        name: 'إطار ذهبي',
                        icon: 'fas fa-square',
                        color: '#C6A467',
                        style: 'gold'
                    },
                    {
                        id: 2,
                        name: 'إطار تراثي',
                        icon: 'fas fa-archway',
                        color: '#8B4513',
                        style: 'heritage'
                    },
                    {
                        id: 3,
                        name: 'إطار أخضر',
                        icon: 'fas fa-leaf',
                        color: '#113D1C',
                        style: 'green'
                    },
                    {
                        id: 4,
                        name: 'إطار بسيط',
                        icon: 'fas fa-border-none',
                        color: '#666666',
                        style: 'simple'
                    },
                    {
                        id: 5,
                        name: 'إطار منقوش',
                        icon: 'fas fa-gem',
                        color: '#8DAE49',
                        style: 'pattern'
                    },
                    {
                        id: 6,
                        name: 'بدون إطار',
                        icon: 'fas fa-times-circle',
                        color: '#999999',
                        style: 'none'
                    }
                ];
                
                this.stickers = [
                    {
                        id: 1,
                        name: 'علم المملكة',
                        image: '../assets/images/sticker-flag.png',
                        type: 'patriotic'
                    },
                    {
                        id: 2,
                        name: 'شعار المملكة',
                        image: '../assets/images/sticker-emblem.png',
                        type: 'patriotic'
                    },
                    {
                        id: 3,
                        name: 'شعار يوم التأسيس',
                        image: '../assets/images/sticker-founding-day.png',
                        type: 'event'
                    },
                    {
                        id: 4,
                        name: 'نخلة',
                        image: '../assets/images/sticker-palm.png',
                        type: 'natural'
                    },
                    {
                        id: 5,
                        name: 'جمل',
                        image: '../assets/images/sticker-camel.png',
                        type: 'natural'
                    },
                    {
                        id: 6,
                        name: 'قلب أخضر',
                        image: '../assets/images/sticker-heart.png',
                        type: 'decoration'
                    }
                ];
                
                this.filters = [
                    {
                        id: 1,
                        name: 'طبيعي',
                        preview: 'linear-gradient(135deg, #ffffff, #ffffff)',
                        filter: 'none'
                    },
                    {
                        id: 2,
                        name: 'قديم',
                        preview: 'linear-gradient(135deg, #8B4513, #D2691E)',
                        filter: 'sepia(0.5) contrast(1.2)'
                    },
                    {
                        id: 3,
                        name: 'أبيض وأسود',
                        preview: 'linear-gradient(135deg, #000000, #ffffff)',
                        filter: 'grayscale(100%)'
                    },
                    {
                        id: 4,
                        name: 'ساطع',
                        preview: 'linear-gradient(135deg, #FFD700, #FFA500)',
                        filter: 'brightness(1.2) saturate(1.5)'
                    },
                    {
                        id: 5,
                        name: 'بارد',
                        preview: 'linear-gradient(135deg, #0000FF, #00FFFF)',
                        filter: 'hue-rotate(180deg)'
                    },
                    {
                        id: 6,
                        name: 'دافئ',
                        preview: 'linear-gradient(135deg, #FF4500, #FFD700)',
                        filter: 'sepia(0.3) saturate(1.4)'
                    }
                ];
                
                this.init();
            }
            
            async init() {
                this.setupEventListeners();
                this.renderBackgrounds();
                this.renderFrames();
                this.renderStickers();
                this.renderFilters();
                this.loadGallery();
                
                // تعيين خلفية افتراضية
                this.setBackground(this.backgrounds[0]);
                this.setFrame(this.frames[0]);
                this.setFilter(this.filters[0]);
            }
            
            setupEventListeners() {
                // إضافة سحب وإفلات للملصقات
                document.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                document.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const stickerId = e.dataTransfer.getData('stickerId');
                    if (stickerId) {
                        this.addStickerToOverlay(parseInt(stickerId), e.clientX, e.clientY);
                    }
                });
            }
            
            renderBackgrounds() {
                const container = document.getElementById('backgroundsGrid');
                if (!container) return;
                
                container.innerHTML = this.backgrounds.map(bg => `
                    <div class="background-btn ${bg.id === 1 ? 'active' : ''}" onclick="photoBooth.setBackground(${bg.id})">
                        <img src="${bg.image}" alt="${bg.name}">
                        <div class="background-name">${bg.name}</div>
                    </div>
                `).join('');
            }
            
            renderFrames() {
                const container = document.getElementById('framesGrid');
                if (!container) return;
                
                container.innerHTML = this.frames.map(frame => `
                    <div class="frame-btn ${frame.id === 1 ? 'active' : ''}" onclick="photoBooth.setFrame(${frame.id})">
                        <i class="${frame.icon}" style="color: ${frame.color}"></i>
                        <div class="frame-name">${frame.name}</div>
                    </div>
                `).join('');
            }
            
            renderStickers() {
                const container = document.getElementById('stickersGrid');
                if (!container) return;
                
                container.innerHTML = this.stickers.map(sticker => `
                    <div class="sticker-btn" draggable="true" ondragstart="event.dataTransfer.setData('stickerId', '${sticker.id}')" onclick="photoBooth.addSticker(${sticker.id})">
                        <img src="${sticker.image}" alt="${sticker.name}">
                    </div>
                `).join('');
            }
            
            renderFilters() {
                const container = document.getElementById('filtersGrid');
                if (!container) return;
                
                container.innerHTML = this.filters.map(filter => `
                    <div class="filter-btn ${filter.id === 1 ? 'active' : ''}" onclick="photoBooth.setFilter(${filter.id})">
                        <div class="filter-preview" style="background: ${filter.preview}"></div>
                        <div class="filter-name">${filter.name}</div>
                    </div>
                `).join('');
            }
            
            async startCamera() {
                try {
                    const constraints = {
                        video: {
                            facingMode: this.currentCamera,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    };
                    
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;
                    
                    // عرض زر التقاط الصورة
                    document.getElementById('captureBtn').style.display = 'block';
                    
                    // تحديث حالة الأزرار
                    this.updateControlButtons(true);
                    
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    alert('تعذر الوصول إلى الكاميرا. يرجى التحقق من الأذونات.');
                }
            }
            
            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                    this.video.srcObject = null;
                    
                    // إخفاء زر التقاط الصورة
                    document.getElementById('captureBtn').style.display = 'none';
                    
                    // تحديث حالة الأزرار
                    this.updateControlButtons(false);
                }
            }
            
            switchCamera() {
                this.currentCamera = this.currentCamera === 'user' ? 'environment' : 'user';
                this.stopCamera();
                this.startCamera();
            }
            
            updateControlButtons(cameraActive) {
                const startBtn = document.querySelector('.control-btn.primary');
                const stopBtn = document.querySelector('.control-btn.danger');
                const switchBtn = document.querySelector('.control-btn:nth-child(2)');
                
                if (cameraActive) {
                    startBtn.innerHTML = '<i class="fas fa-camera"></i> الكاميرا تعمل';
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    switchBtn.disabled = false;
                } else {
                    startBtn.innerHTML = '<i class="fas fa-camera"></i> تشغيل الكاميرا';
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    switchBtn.disabled = true;
                }
            }
            
            capturePhoto() {
                if (!this.stream) return;
                
                // ضبط أبعاد الكانفاس
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;
                
                // رسم الفيديو على الكانفاس
                this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                
                // تطبيق الخلفية
                if (this.currentBackground) {
                    this.applyBackground();
                }
                
                // تطبيق الفلتر
                if (this.currentFilter) {
                    this.applyFilter();
                }
                
                // تطبيق الإطار
                if (this.currentFrame && this.currentFrame.style !== 'none') {
                    this.applyFrame();
                }
                
                // تطبيق الملصقات
                this.applyStickers();
                
                // الحصول على صورة النتيجة
                this.currentPhoto = this.canvas.toDataURL('image/png');
                this.photoResult.src = this.currentPhoto;
                this.shareImage.src = this.currentPhoto;
                
                // عرض معاينة الصورة
                document.getElementById('photoPreview').style.display = 'block';
                
                // إيقاف الكاميرا
                this.stopCamera();
            }
            
            applyBackground() {
                if (!this.currentBackground) return;
                
                const bgImage = new Image();
                bgImage.crossOrigin = 'anonymous';
                bgImage.onload = () => {
                    // حفظ الصورة الأصلية
                    const originalImage = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                    
                    // مسح الكانفاس
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // رسم الخلفية
                    this.ctx.drawImage(bgImage, 0, 0, this.canvas.width, this.canvas.height);
                    
                    // رسم الصورة الأصلية مع خلفية شفافة
                    this.ctx.putImageData(originalImage, 0, 0);
                };
                bgImage.src = this.currentBackground.image;
            }
            
            applyFilter() {
                if (!this.currentFilter) return;
                
                this.ctx.filter = this.currentFilter.filter;
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.putImageData(imageData, 0, 0);
                this.ctx.filter = 'none';
            }
            
            applyFrame() {
                if (!this.currentFrame || this.currentFrame.style === 'none') return;
                
                const frameWidth = 20;
                const cornerSize = 40;
                
                // رسم الإطار
                this.ctx.strokeStyle = this.currentFrame.color;
                this.ctx.lineWidth = frameWidth;
                this.ctx.strokeRect(
                    frameWidth / 2,
                    frameWidth / 2,
                    this.canvas.width - frameWidth,
                    this.canvas.height - frameWidth
                );
                
                // زوايا زخرفية (للمظهر التراثي)
                if (this.currentFrame.style === 'heritage' || this.currentFrame.style === 'gold') {
                    this.ctx.fillStyle = this.currentFrame.color;
                    
                    // الزوايا الأربع
                    const corners = [
                        [0, 0],
                        [this.canvas.width - cornerSize, 0],
                        [0, this.canvas.height - cornerSize],
                        [this.canvas.width - cornerSize, this.canvas.height - cornerSize]
                    ];
                    
                    corners.forEach(([x, y]) => {
                        this.ctx.beginPath();
                        this.ctx.moveTo(x, y + cornerSize);
                        this.ctx.lineTo(x + cornerSize, y);
                        this.ctx.lineTo(x + cornerSize, y + cornerSize);
                        this.ctx.closePath();
                        this.ctx.fill();
                        
                        this.ctx.beginPath();
                        this.ctx.moveTo(x, y);
                        this.ctx.lineTo(x + cornerSize, y);
                        this.ctx.lineTo(x, y + cornerSize);
                        this.ctx.closePath();
                        this.ctx.fill();
                    });
                }
            }
            
            applyStickers() {
                this.activeStickers.forEach(sticker => {
                    const stickerImg = new Image();
                    stickerImg.onload = () => {
                        const size = 100; // حجم الملصق
                        this.ctx.drawImage(
                            stickerImg,
                            sticker.x - size / 2,
                            sticker.y - size / 2,
                            size,
                            size
                        );
                    };
                    stickerImg.src = sticker.image;
                });
            }
            
            setBackground(backgroundId) {
                const background = this.backgrounds.find(bg => bg.id === backgroundId);
                if (background) {
                    this.currentBackground = background;
                    
                    // تحديث الأزرار النشطة
                    document.querySelectorAll('.background-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    event.target.closest('.background-btn').classList.add('active');
                }
            }
            
            setFrame(frameId) {
                const frame = this.frames.find(f => f.id === frameId);
                if (frame) {
                    this.currentFrame = frame;
                    
                    // تحديث الأزرار النشطة
                    document.querySelectorAll('.frame-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    event.target.closest('.frame-btn').classList.add('active');
                }
            }
            
            setFilter(filterId) {
                const filter = this.filters.find(f => f.id === filterId);
                if (filter) {
                    this.currentFilter = filter;
                    
                    // تحديث الأزرار النشطة
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    event.target.closest('.filter-btn').classList.add('active');
                }
            }
            
            addSticker(stickerId) {
                const sticker = this.stickers.find(s => s.id === stickerId);
                if (sticker) {
                    // إضافة الملصق في منتصف الشاشة
                    this.addStickerToOverlay(stickerId, this.canvas.width / 2, this.canvas.height / 2);
                }
            }
            
            addStickerToOverlay(stickerId, x, y) {
                const sticker = this.stickers.find(s => s.id === stickerId);
                if (!sticker) return;
                
                const overlay = document.getElementById('cameraOverlay');
                const stickerElement = document.createElement('img');
                stickerElement.className = 'overlay-element';
                stickerElement.src = sticker.image;
                stickerElement.style.width = '100px';
                stickerElement.style.height = '100px';
                stickerElement.style.position = 'absolute';
                stickerElement.style.left = `${x - 50}px`;
                stickerElement.style.top = `${y - 50}px`;
                stickerElement.style.cursor = 'move';
                stickerElement.draggable = true;
                
                // جعل العنصر قابل للسحب
                this.makeDraggable(stickerElement);
                
                overlay.appendChild(stickerElement);
                
                // حفظ الملصق في القائمة النشطة
                this.activeStickers.push({
                    id: sticker.id,
                    image: sticker.image,
                    x: x,
                    y: y,
                    element: stickerElement
                });
            }
            
            makeDraggable(element) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                
                element.onmousedown = dragMouseDown;
                element.ontouchstart = touchStart;
                
                function dragMouseDown(e) {
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    document.onmousemove = elementDrag;
                }
                
                function touchStart(e) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    pos3 = touch.clientX;
                    pos4 = touch.clientY;
                    document.ontouchend = closeDragElement;
                    document.ontouchmove = touchMove;
                }
                
                function elementDrag(e) {
                    e.preventDefault();
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    element.style.top = (element.offsetTop - pos2) + "px";
                    element.style.left = (element.offsetLeft - pos1) + "px";
                }
                
                function touchMove(e) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    pos1 = pos3 - touch.clientX;
                    pos2 = pos4 - touch.clientY;
                    pos3 = touch.clientX;
                    pos4 = touch.clientY;
                    element.style.top = (element.offsetTop - pos2) + "px";
                    element.style.left = (element.offsetLeft - pos1) + "px";
                }
                
                function closeDragElement() {
                    document.onmouseup = null;
                    document.onmousemove = null;
                    document.ontouchend = null;
                    document.ontouchmove = null;
                }
            }
            
            retakePhoto() {
                // إخفاء المعاينة
                document.getElementById('photoPreview').style.display = 'none';
                
                // إعادة تشغيل الكاميرا
                this.startCamera();
                
                // مسح الملصقات النشطة
                this.clearOverlay();
            }
            
            clearOverlay() {
                this.overlay.innerHTML = '';
                this.activeStickers = [];
            }
            
            savePhoto() {
                if (!this.currentPhoto) return;
                
                // حفظ الصورة في localStorage
                const photos = JSON.parse(localStorage.getItem('boothPhotos') || '[]');
                photos.push({
                    id: Date.now(),
                    data: this.currentPhoto,
                    date: new Date().toISOString(),
                    background: this.currentBackground?.name,
                    frame: this.currentFrame?.name,
                    stickers: this.activeStickers.length
                });
                
                localStorage.setItem('boothPhotos', JSON.stringify(photos));
                
                // تحديث المعرض
                this.loadGallery();
                
                alert('تم حفظ الصورة بنجاح!');
            }
            
            loadGallery() {
                const container = document.getElementById('photosGrid');
                if (!container) return;
                
                const photos = JSON.parse(localStorage.getItem('boothPhotos') || '[]');
                
                if (photos.length === 0) {
                    container.innerHTML = `
                        <div class="no-photos">
                            <i class="fas fa-camera" style="font-size: 3rem; color: var(--light-gray); margin-bottom: 1rem;"></i>
                            <p>لا توجد صور محفوظة بعد</p>
                            <p>التقطي صورة أولاً!</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = photos.slice(-12).reverse().map(photo => `
                    <div class="photo-item" onclick="photoBooth.viewPhoto('${photo.id}')">
                        <img src="${photo.data}" alt="صورة محفوظة">
                        <div class="photo-info">
                            <div>${new Date(photo.date).toLocaleDateString('ar-SA')}</div>
                            <div>${photo.background}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            viewPhoto(photoId) {
                const photos = JSON.parse(localStorage.getItem('boothPhotos') || '[]');
                const photo = photos.find(p => p.id == photoId);
                
                if (photo) {
                    this.currentPhoto = photo.data;
                    this.photoResult.src = photo.data;
                    this.shareImage.src = photo.data;
                    document.getElementById('photoPreview').style.display = 'block';
                    window.scrollTo({ top: document.getElementById('photoPreview').offsetTop - 100, behavior: 'smooth' });
                }
            }
            
            sharePhoto() {
                if (!this.currentPhoto) return;
                
                // عرض نافذة المشاركة
                document.getElementById('shareModal').style.display = 'flex';
            }
        }
        
        // تهيئة ركن الصور
        let photoBooth;
        document.addEventListener('DOMContentLoaded', () => {
            photoBooth = new PhotoBooth();
        });
        
        // وظائف عامة
        function startCamera() {
            if (photoBooth) {
                photoBooth.startCamera();
            }
        }
        
        function stopCamera() {
            if (photoBooth) {
                photoBooth.stopCamera();
            }
        }
        
        function switchCamera() {
            if (photoBooth) {
                photoBooth.switchCamera();
            }
        }
        
        function capturePhoto() {
            if (photoBooth) {
                photoBooth.capturePhoto();
            }
        }
        
        function retakePhoto() {
            if (photoBooth) {
                photoBooth.retakePhoto();
            }
        }
        
        function savePhoto() {
            if (photoBooth) {
                photoBooth.savePhoto();
            }
        }
        
        function sharePhoto() {
            if (photoBooth) {
                photoBooth.sharePhoto();
            }
        }
        
        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
        }
        
        function shareOnTwitter() {
            const text = encodeURIComponent('شاركت في ركن "أنا وطني" بيوم التأسيس السعودي! 🇸🇦 #يوم_التأسيس #رحلة_التأسيس');
            const url = encodeURIComponent(window.location.href);
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
        }
        
        function shareOnInstagram() {
            alert('للمشاركة على إنستغرام، احفظ الصورة أولاً ثم انشرها من تطبيق إنستغرام');
            downloadPhoto();
        }
        
        function shareOnWhatsApp() {
            const text = encodeURIComponent('شاركت في ركن "أنا وطني" بيوم التأسيس السعودي! شاهد صورتي 👇');
            const url = window.location.href;
            window.open(`https://wa.me/?text=${text}%20${url}`, '_blank');
        }
        
        function downloadPhoto() {
            if (photoBooth && photoBooth.currentPhoto) {
                const link = document.createElement('a');
                link.download = `صورة-وطنية-${new Date().getTime()}.png`;
                link.href = photoBooth.currentPhoto;
                link.click();
            }
        }
        
        function postToGallery() {
            const caption = document.getElementById('shareCaption').value;
            savePhoto();
            closeShareModal();
            alert('تم نشر صورتك في المعرض بنجاح!');
        }
        
        // تصدير للاستخدام في الملفات الأخرى
        window.PhotoBooth = PhotoBooth;
        window.photoBooth = photoBooth;
    </script>
</body>
</html>